<script>
var dispatcher = new WebSocketRails('<%= request.host_with_port() %>/websocket');
var channel = dispatcher.subscribe_private("g<%= params[:id] %>")

dispatcher.bind('client_connected',function(message){
	console.log(message);
});

var appendMessage = function(text,author_name,self_message){
	var message_div = document.createElement('div');
	if (self_message) {
		 message_div.className = "bubble bubble--alt";
	}else{
		message_div.className = "bubble";
	}
	message_div.innerHTML  = author_name + ":" + text;
　	document.getElementById("messages_table").appendChild( message_div);
　	$('#messages_table').scrollTop($('#messages_table')[0].scrollHeight);
}

channel.bind("messages.new", function(message){
	console.log("GOT IT");
	console.log(message);
	appendMessage(message.text,message.author_name,(message.author_id == <%= current_user.id%>));
});

var send_message = function(){
	var text = $('#message_text').val()
	$('#message_form #text').val(text)
	$('#message_text').val('')
	$('#message_form').submit()
};

$(document).ready(function(){
	$('#messages_table').scrollTop($('#messages_table')[0].scrollHeight);

	$('#message_text').keyup(function(event){
			if(event.keyCode == 13){
				console.log("ENTER");
				send_message();
			}
	});

});


</script>
